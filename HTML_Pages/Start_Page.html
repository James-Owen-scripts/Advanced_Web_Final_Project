<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Powerlifting Discussion Forum</title>
        <link rel="shortcut icon" href="../Resources/Images/logo.ico" />
    
        <!--Bootstrap-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
        <!--JQuery-->
        <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.1.1.min.js"></script>
    
        <!--Style Sheet-->
        <link href="../Styles/OverallStyles.css" rel="stylesheet" />
        <link href="../Styles/Start_Page.css" rel="stylesheet" />
    </head>
    <body>
        <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
            <div class="container-fluid">
              <a class="navbar-brand active" href="#"><img id="logo" src="../Resources/Images/logo.png" alt="Home" /></a>
              <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleNavbar">
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="collapsibleNavbar">
                <ul class="navbar-nav">
                  <li class="nav-item">
                    <a class="nav-link" id="profileNav" href="#">Profile</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="myPostsNav" href="#">My Posts</a>
                  </li>
                </ul>
                <div class="d-flex">
                    <a class="nav-link text-danger" id="logOutNav" href="#">Log Out</a>
                </div>
              </div>
            </div>
        </nav>
        <div id="postsSegment" style="display: none;">
            <div class="container" id="startPagePosts">
                <div class="row">
                    <h1 style="text-align: center;">Posts</h1>
                    <button class="btn btn-primary w-50" style="position: relative; left: 40%; margin-bottom: 2em;" data-bs-toggle="modal" data-bs-target="#createPost">Create Post</button>
                </div>
                <form id="filter-form">
                    <input type="hidden" name="page" value="startPage" />
                    <input type="hidden" name="command" value="applyFilters" />
                    <div class="row bg-secondary mt-10">
                        <div class="col">
                            <div class="mb-3">
                                <label class="form-label" for="search">search &#x1F50E;&#xFE0E;</label>
                                <input class="form-control" type="text" id="search" name="search" />
                            </div>
                        </div>
                        <div class="col">
                            <div class="mb-3">
                                <label class="form-label" for="group-by">Group-by:</label>
                                <select class="form-control" id="group-by" name="order">
                                    <option>Newest-To-Oldest</option>
                                    <option>Oldest-To-Newest</option>
                                    <option>Popularity</option>
                                </select>
                            </div>
                        </div>
                        <div class="col">
                            <div class="mb-3">
                                <label class="form-label" for="experience">Experience:</label>
                                <select class="form-control" id="experience" name="experience">
                                    <option></option>
                                    <option>Begginner</option>
                                    <option>Intermediate</option>
                                    <option>Expert</option>
                                    <option>Coach</option>
                                </select>
                            </div>
                        </div>
                        <div class="col">
                            <button id="filter-submit" style="position: relative; top: 2em;" type="submit" class="btn btn-primary">Submit</button>
                        </div>
                    </div>
                </form>
                <div id="posts"></div>
            </div>
            
            <!--Create post modal-->
            <div class="modal fade" id="createPost">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form id="createPostForm">
                            <div class="modal-header">
                                <h2>Create Post</h2>
                                <input type="hidden" name="page" value="startPage" />
                                <input type="hidden" name="command" value="createPost"/>
                            </div>
                            <div class="modal-body">
                                <label class="control-label" for="postTitle">Post Title:</label>
                                <input type="text" class="form-control" id="postTitle" name="postTitle" required/>
                                <label class="control-label" for="postContent">Content</label>
                                <textarea class="form-control" id="postContent" name="postContent" rows="5" required></textarea>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" id="model-createPost-submit" class="btn btn-outline-primary">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div id="fullPostSegment" style="display: none;">
            <div class="container bg-light">
                <h1>Post</h1>
                <div class="row">
                    <div class="col-12" id="postSection">
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <form id="makeComment">
                            <div class="mb-3 mt-3">
                                <label for="comment" class="form-label">Comment on Post:</label>
                                <textarea id="comment" name="comment" class="form-control" rows="5" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-outline-primary mb-2" id="commentBtn">Submit</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div id="profileSegment" style="display: none">
            <h1>Hello from profile page</h1>
        </div>
        <div id="myPostsSegment" style="display: none;">
            <div class="container bg-light">
                <h1>My Posts:</h1>
                <div id="myPosts">
                    <div class="card bg-info mb-2">
                        <div class="card-header">
                            <h2>Username</h2>
                            <h3>Experience</h3>
                            <h3>Totals</h3>
                            <button type="button" view-mypost-com-id="1" class="btn btn-outline-primary">View Comments</button>
                            <button type="button" delete-mypost-id="1" class="btn btn-outline-danger">Delete post</button>
                        </div>
                        <div class="card-body">
                            <h3>Post Title</h3>
                        </div>
                        <div class="card-footer">
                            <p style="color: grey;">Date posted</p>
                        </div>
                    </div>
                    <div class="card bg-info mb-2">
                        <div class="card-header">Header</div>
                        <div class="card-body">Body</div>
                        <div class="card-footer">footer</div>
                    </div>
                </div>
                <div class="mt-2">
                    <p>End of my post content</p>
                </div>
            </div>
        </div>
    </body>
    <!--JQuery control for document-->
    <script>
        let controller = '../Controller.php';

        // add page data
        function pageData(pageOn) {
            if (pageOn === 'posts') {
                $('#fullPostSegment').css('display', 'none');
                $('#postsSegment').css('display', 'block');
                $('#profileSegment').css('display', 'none');
                $('#myPostsSegment').css('display', 'none');
                savedFilters();
                // add posts when page is refreshed
                addPosts();
            }
            else if (pageOn === 'seePost') {
                $('#fullPostSegment').css('display', 'block');
                $('#postsSegment').css('display', 'none');
                $('#profileSegment').css('display', 'none');
                $('#myPostsSegment').css('display', 'none');
                loadPost();
            }
            else if (pageOn === 'profile') {
                $('#fullPostSegment').css('display', 'none');
                $('#postsSegment').css('display', 'none');
                $('#profileSegment').css('display', 'block');
                $('#myPostsSegment').css('display', 'none');
            }
            else if (pageOn === 'myPosts') {
                $('#fullPostSegment').css('display', 'none');
                $('#postsSegment').css('display', 'none');
                $('#profileSegment').css('display', 'none');
                $('#myPostsSegment').css('display', 'block');
                showMyPosts();
            }
        }

        // check which page should be shown
        function checkPage() {
            let query = {
                page: 'startPage',
                command: 'pageType'
            }

            $.ajax({
                url: controller,
                data: query,
                type: 'POST',
                success: (data) => {
                    pageData(data);
                }
            });
        }

        // function to log out user
        function logOut() {
            let query = {
                page: 'startPage',
                command: 'logOut'
            };
            $.post(controller, query, function(data) {
                location.reload();
            });
        }

        // handle user navigation
        function nav(dir) {
            let query = {
                page: 'startPage',
                command: 'nav',
                directory: dir 
            };
            $.post(controller, query, function() {
                pageData(query.directory);
            });
        }

        // Posts Page Functions:
        function addPosts() {
            $.ajax({url: controller,
                data: {page:'startPage', command: 'getPosts'},
                type: 'post',    
                success: function(data) {
                    let post_data = JSON.parse(data);
                    let str = '';
                    // add cards to document
                    for (let i = 0; i < post_data.length; i++) {
                        // check if a new row needs to be added
                        if (i !== 0) {
                            str += '</div>';
                        }
                        str += '<div class="row mt-3">';
                        // add the card
                        str += '<div class="col-12"><div class="card mt-3 bg-light" data-id="' + post_data[i]['POST_ID'] + '"">';
                        // card header with username
                        str += '<div class="card-header"><h3>' + post_data[i]['USERNAME'] + '</h3>';
                        // check if user has experience
                        if (post_data[i]['LIFT_EXPERIENCE'] !== null) {
                            str += '<p>Experience: ' + post_data[i]['LIFT_EXPERIENCE'] + '</p>';
                        }
                        else {
                            str += '<p>Experience: none </p>';
                        }
                        str += '<p>';
                        // CHECK IF USER HAS SET A SQUAT TOTAL
                        if (post_data[i]['SQUAT_TOTAL'] !== null ) {
                            str += 'Totals: ( SQ-' + post_data[i]['SQUAT_TOTAL'] + 'Kg | ';
                        }
                        else {
                            str += 'Totals: ( SQ-NA | ';
                        }
                        // CHECK IF USER HAS SET A bench TOTAL
                        if (post_data[i]['BENCH_TOTAL'] !== null ) {
                            str += 'BP-NA|' + post_data[i]['BENCH_TOTAL'] + 'Kg | ';
                        }
                        else {
                            str += 'BP-NA | ';
                        }
                        // CHECK IF USER HAS SET A SQUAT TOTAL
                        if (post_data[i]['DEADLIFT_TOTAL'] !== null ) {
                            str += 'DL-' + post_data[i]['SQUAT_TOTAL'] + 'Kg )</p>';
                        }
                        else {
                            str += 'DL-NA )</p>';
                        }
                        // end head and add card body
                        str += '</div><div class="card-body"><h2>' + post_data[i]['POST_TITLE'] + '</h2></div>';
                        // footer of the card
                        str += '<div class="card-footer"><p style="color: grey;">Date posted: ' + post_data[i]['DATE_POSTED'] + '</p></div></div></div>';
                        // add div end when the end of the posts has been reached
                        if (i === post_data.length -1) {
                            str += '</div>';
                        }
                    }
                    $('div#posts').html(str); // add posts to page

                    // make posts dynamic hoverable
                    $('div[data-id]').hover(
                        function() {
                            $(this).removeClass("bg-light").addClass("bg-info");
                            $(this).css('cursor', 'pointer');
                        },
                        function() {
                            $(this).removeClass("bg-info").addClass("bg-light");
                        }
                    );
                    
                    // add event listeners for clicking
                    $('div[data-id]').click(function() {
                        postSelect($(this).attr('data-id'));
                    });
                }
            });
        }

        function savedFilters() {
            let query = {
                page: 'startPage', 
                command: 'getFilters'
            }
            $.ajax({
                url: controller,
                data: query,
                type: 'post',
                success: function(data) {
                    let post_data = JSON.parse(data);
                    // add the data to the form so it is remembered
                    $('#search').val(post_data['search']);
                    $('#group-by').val(post_data['order']);
                    $('#experience').val(post_data['experience']);
                }
            });
        }

        // redirect to full selected posts
        function postSelect(post_id) {
            let query = {
                page: 'startPage',
                command: 'seePost',
                post: post_id
            };

            $.ajax({
                url: controller,
                type: 'POST',
                data: query,
                success: function(data) {
                    location.reload();
                }
            });
        }

        // for if user would like to change the filters
        $('#filter-form').submit(function(event) {
            event.preventDefault(); // Prevent the default form submission
            
            let formData = new FormData(this);
            
            // Send the form data to the server using AJAX POST request
            $.ajax({
                url: controller,
                type: 'POST',
                data: formData, // Send the FormData object directly
                processData: false, // Prevent jQuery from processing the data
                contentType: false, // Prevent jQuery from setting the Content-Type header
                success: function(data) {
                    // Handle the response data here
                    addPosts();
                },
                error: function(xhr, status, error) {
                    // Handle errors here
                    console.error(xhr.responseText);
                }
            });
        });

        // create post
        $('#createPostForm').submit(function(event) {
            event.preventDefault();

            let formData = new FormData(this);

            $.ajax({
                url: controller,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function() {
                    $('#createPost').modal('hide');
                    addPosts();
                    alert('Post Created');
                }
            });
        });



        // seePost functions
        // load post
        function loadPost() {
            let query = {
                page: 'startPage',
                command: 'getPost'
            }
            $.ajax({
                url: controller,
                data: query,
                type: 'POST',
                success: function(data) {
                    data = JSON.parse(data);
                    
                    // head of post
                    let str = '<div class="card bg-info mt-2 mb-2"><div class="card-header"><h2>By: ';
                    str += data['post']['USERNAME'] + '</h2><h3>' + data['post']['POST_TITLE'] + '</h3>';
                    if (data['post']['EXPERIENCE'] == null) {
                        str += '<h4>Experience: none</h4>';
                    }
                    else {
                        str += '<h4>Experience: ' + data['post']['EXPERIENCE'] + '</h4>';
                    }
                    if (data['post']['SQUAT_TOTAL'] == null) {
                        str += '<h4>Totals: ( SQ-NA | ';
                    }
                    else {
                        str += '<h4>Totals: ( SQ-' + data['post']['SQUAT_TOTAL'] + 'Kg | ';
                    }
                    if (data['post']['BENCH_TOTAL'] == null) {
                        str += 'BP-NA | ';
                    }
                    else {
                        str += 'BP-' + data['post']['BENCH_TOTAL'] + 'Kg | ';
                    }
                    if (data['post']['DEADLIFT_TOTAL'] == null) {
                        str += 'DL-NA )</h4></div>';
                    }
                    else {
                        str += 'DL-' + data['post']['DEADLIFT_TOTAL'] + 'Kg )</h4></div>';
                    }

                    // post body
                    str += '<div class="card-body"><p>' + data['post']['POST_CONTENT'] + '</p></div>';

                    // post footer
                    str += '<div class="card-footer"><p style="color: grey;">Posted on: ' + data['post']['DATE_POSTED'] + '</p>';
                    
                    //  comments in footer
                    str += '<div id="comments">';
                    data['comments'].forEach((comment) => {
                        // comment head
                        str += '<div class="card bg-light mb-2"><div class="card-header"><h3>User: ';
                        str += comment['USERNAME'] + '</h3>';
                        if (comment['EXPERIENCE'] == null) {
                        str += '<p>Experience: none</p>';
                        }
                        else {
                            str += '<p>Experience: ' + comment['EXPERIENCE'] + '</p>';
                        }
                        if (comment['SQUAT_TOTAL'] == null) {
                            str += '<p>Totals: ( SQ-NA | ';
                        }
                        else {
                            str += '<p>Totals: ( SQ-' + comment['SQUAT_TOTAL'] + 'Kg | ';
                        }
                        if (comment['BENCH_TOTAL'] == null) {
                            str += 'BP-NA | ';
                        }
                        else {
                            str += 'BP-' + comment['BENCH_TOTAL'] + 'Kg | ';
                        }
                        if (comment['DEADLIFT_TOTAL'] == null) {
                            str += 'DL-NA )</p></div>';
                        }
                        else {
                            str += 'DL-' + comment['DEADLIFT_TOTAL'] + 'Kg )</p></div>';
                        }

                        // comment body
                        str += '<div class="card-body"><p>' + comment['POST_COMMENT'] + '</p></div>';

                        // comment footer
                        str += '<div class="card-footer"><p style="color: grey;">' + comment['DATE_COMMENTED'] + '</p></div></div>';
                    });
                    str += '</div></div>';

                    $('#postSection').html(str);
                }
            });
        }

        // comment on post
        $('#makeComment').submit(function(event) {
            event.preventDefault();
            let commentContent = $('textarea#comment').val();

            let query = {
                page: 'startPage',
                command: 'commentOnPost',
                comment: commentContent
            };

            $.ajax({
                url: controller,
                type: 'POST',
                data: query,
                success: () => {
                    $('textarea#comment').val('');
                    loadPost();
                }
            })
        });


        // My Posts functions
        //  Delete post
        function deletePost(postId) {
            console.log(postId);
            let query = {
                page: 'startPage',
                command: 'deletePost',
                postID: postId
            };

            $.ajax({
                url: controller,
                type: 'POST',
                data: query,
                success: (data) => {
                    console.log(data);
                    showMyPosts();
                }
            });
        }

        //  show my posts function
        function showMyPosts() {
            let query = {
                page: 'startPage',
                command: 'myPosts'
            };

            $.ajax({
                url: controller,
                type: 'POST',
                data: query,
                success: (data) => {
                    data = JSON.parse(data);
                    let str = '';

                    // add each of the user posts
                    data.forEach((post) => {
                        // post header
                        str += '<div class="card bg-light mb-2"><div class="card-header">';
                        str += '<h2>' + post['USERNAME'] + '</h2>';
                        if (post['EXPERIENCE'] === null) {
                            str += '<p>Experience: none</p>'; 
                        }
                        else {
                            str += '<p>Experience: ' + post['EXPEREINCE'] + '</p>';
                        }
                        if (post['SQUAT_TOTAL'] === null) {
                            str += '<p>Totals: ( SQ-NA | '; 
                        }
                        else {
                            str += str += '<p>Totals: ( SQ-' + post['SQUAT_TOTAL'] + 'Kg | ';
                        }
                        if (post['BENCH_TOTAL'] === null) {
                            str += 'BP-NA | '; 
                        }
                        else {
                            str += str += 'BP-' + post['BENCH_TOTAL'] + 'Kg | ';
                        }
                        if (post['DEADLIFT_TOTAL'] === null) {
                            str += 'DL-NA )'; 
                        }
                        else {
                            str += str += 'DL-' + post['DEADLIFT_TOTAL'] + 'Kg )</p>';
                        }
                        // adding buttons
                        str += '<div id=addButtons>';
                        str += '<button type="button" view-mypost-com-id="' + post['POST_ID'] + '" class="btn btn-outline-primary">View Comments</button>';
                        str += '<button type="button" delete-mypost-id="' + post['POST_ID'] + '" class="btn btn-outline-danger">Delete post</button></div>';
                        str += '</div>';

                        // body of post
                        str += '<div class="card-body"><h3>' + post['POST_TITLE'] + '</h3></div>';

                        // footer of post
                        str += '<div class="card-footer"><p style="color: grey;">' + post['DATE_POSTED'] + '</p></div>';

                        // end of post
                        str += '</div>';
                    });

                    // add posts to the page
                    $('#myPosts').html(str);

                    // add event listener to view post
                    $('button[view-mypost-com-id]').click(function() {
                        postSelect($(this).attr('view-mypost-com-id'));
                    });
                    // add event listener to delete post
                    $('button[delete-mypost-id]').click(function() {
                        deletePost($(this).attr('delete-mypost-id'));
                    });
                }
            })
        }

        //handle logout click
        $('#logOutNav').click(logOut);
        // handle profile click
        $('#profileNav').click(() => {nav('profile');});
        // handle my posts click
        $('#myPostsNav').click(() => {nav('myPosts')});
        // handle if logo is clicked
        $('#logo').click(() => {nav('posts')});
        // check the page
        checkPage();
    </script>
</html>