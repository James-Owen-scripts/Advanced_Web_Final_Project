<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Powerlifting Discussion Forum</title>
        <link rel="shortcut icon" href="../Resources/Images/logo.ico" />
    
        <!--Bootstrap-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
        <!--JQuery-->
        <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.1.1.min.js"></script>
    
        <!--Style Sheet-->
        <link href="../Styles/OverallStyles.css" rel="stylesheet" />
        <link href="../Styles/Start_Page.css" rel="stylesheet" />
    </head>
    <body>
        <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
            <div class="container-fluid">
              <a class="navbar-brand active" href="#"><img id="logo" src="../Resources/Images/logo.png" alt="Home" /></a>
              <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleNavbar">
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="collapsibleNavbar">
                <ul class="navbar-nav">
                  <li class="nav-item">
                    <a class="nav-link" id="profileNav" href="#">Profile</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="myPostsNav" href="#">My Posts</a>
                  </li>
                </ul>
                <div class="d-flex">
                    <a class="nav-link text-danger" id="logOutNav" href="#">Log Out</a>
                </div>
              </div>
            </div>
        </nav>
        <div class="container" id="startPagePosts">
            <div class="row">
                <h1 style="text-align: center;">Posts</h1>
                <button class="btn btn-primary w-50" style="position: relative; left: 40%; margin-bottom: 2em;" data-bs-toggle="modal" data-bs-target="#createPost">Create Post</button>
            </div>
            <form id="filter-form">
                <input type="hidden" name="page" value="startPage" />
                <input type="hidden" name="command" value="applyFilters" />
                <div class="row bg-secondary mt-10">
                    <div class="col">
                        <div class="mb-3">
                            <label class="form-label" for="search">search &#x1F50E;&#xFE0E;</label>
                            <input class="form-control" type="text" id="search" name="search" />
                        </div>
                    </div>
                    <div class="col">
                        <div class="mb-3">
                            <label class="form-label" for="group-by">Group-by:</label>
                            <select class="form-control" id="group-by" name="order">
                                <option>Newest-To-Oldest</option>
                                <option>Oldest-To-Newest</option>
                                <option>Popularity</option>
                            </select>
                        </div>
                    </div>
                    <div class="col">
                        <div class="mb-3">
                            <label class="form-label" for="experience">Experience:</label>
                            <select class="form-control" id="experience" name="experience">
                                <option></option>
                                <option>Begginner</option>
                                <option>Intermediate</option>
                                <option>Expert</option>
                                <option>Coach</option>
                            </select>
                        </div>
                    </div>
                    <div class="col">
                        <button id="filter-submit" style="position: relative; top: 2em;" type="submit" class="btn btn-primary">Submit</button>
                    </div>
                </div>
            </form>
            <div id="posts"></div>
        </div>

        <!--Create post modal-->
        <div class="modal fade" id="createPost">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="createPostForm">
                        <div class="modal-header">
                            <h2>Create Post</h2>
                            <input type="hidden" name="page" value="startPage" />
                            <input type="hidden" name="command" value="createPost"/>
                        </div>
                        <div class="modal-body">
                            <label class="control-label" for="postTitle">Post Title:</label>
                            <input type="text" class="form-control" id="postTitle" name="postTitle" required/>
                            <label class="control-label" for="postContent">Content</label>
                            <textarea class="form-control" id="postContent" name="postContent" rows="5" required></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" id="model-createPost-submit" class="btn btn-outline-primary">Submit</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </body>
    <!--JQuery control for document-->
    <script>
        let controller = '../Controller.php';

        // function to log out user
        function logOut() {
            let query = {
                page: 'startPage',
                command: 'logOut'
            };
            $.post(controller, query, function(data) {
                location.reload();
            });
        }

        // redirect to profile
        function profile() {
            let query = {
                page: 'startPage',
                command: 'profile'
            };
            $.post(controller, query, function(data) {
                document.write(data);
            });
        }

        // redirect to my posts
        function myPosts() {
            let query = {
                page: 'startPage',
                command: 'myPosts'
            };
            $.post(controller, query, function(data) {
                document.write(data);
            });
        }

        function addPosts() {
            $.ajax({url: controller,
                data: {page:'startPage', command: 'getPosts'},
                type: 'post',    
                success: function(data) {
                    let post_data = JSON.parse(data);
                    let str = '';
                    // add cards to document
                    for (let i = 0; i < post_data.length; i++) {
                        // check if a new row needs to be added
                        if (i !== 0) {
                            str += '</div>';
                        }
                        str += '<div class="row mt-3">';
                        // add the card
                        str += '<div class="col-12"><div class="card mt-3 bg-info" data-id="' + post_data[i]['POST_ID'] + '"">';
                        // card header with username
                        str += '<div class="card-header"><h3>' + post_data[i]['USERNAME'] + '</h3>';
                        // check if user has experience
                        if (post_data[i]['LIFT_EXPERIENCE'] !== null) {
                            str += '<p style="color: red;">Experience: ' + post_data[i]['LIFT_EXPERIENCE'] + '</p>';
                        }
                        else {
                            str += '<p style="color: red;">Experience: NOT SET </p>';
                        }
                        str += '<p style="color: grey;">';
                        // CHECK IF USER HAS SET A SQUAT TOTAL
                        if (post_data[i]['SQUAT_TOTAL'] !== null ) {
                            str += 'Totals: ( SQ-' + post_data[i]['SQUAT_TOTAL'] + 'Kg | ';
                        }
                        else {
                            str += 'Totals: (SQ-NA | ';
                        }
                        // CHECK IF USER HAS SET A bench TOTAL
                        if (post_data[i]['BENCH_TOTAL'] !== null ) {
                            str += 'BP-NA|' + post_data[i]['BENCH_TOTAL'] + 'Kg | ';
                        }
                        else {
                            str += 'BP-NA | ';
                        }
                        // CHECK IF USER HAS SET A SQUAT TOTAL
                        if (post_data[i]['DEADLIFT_TOTAL'] !== null ) {
                            str += 'DL-' + post_data[i]['SQUAT_TOTAL'] + 'Kg )</p>';
                        }
                        else {
                            str += 'DL-NA)</p>';
                        }
                        // end head and add card body
                        str += '</div><div class="card-body"><h2>' + post_data[i]['POST_TITLE'] + '</h2></div>';
                        // footer of the card
                        str += '<div class="card-footer"><p>Date posted: ' + post_data[i]['DATE_POSTED'] + '</p></div></div></div>';
                        // add div end when the end of the posts has been reached
                        if (i === post_data.length -1) {
                            str += '</div>';
                        }
                    }
                    $('div#posts').html(str); // add posts to page

                    // make posts dynamic hoverable
                    $('div[data-id]').hover(
                        function() {
                            $(this).removeClass("bg-info").addClass("bg-warning");
                            $(this).css('cursor', 'pointer');
                        },
                        function() {
                            $(this).removeClass("bg-warning").addClass("bg-info");
                        }
                    );
                    
                    // add event listeners for clicking
                    $('div[data-id]').click(function() {
                        // TODO: make click take user to next page
                        alert('clicked ' + $(this).attr('data-id'));
                    });
                }
            });
        }

        function savedFilters() {
            let query = {
                page: 'startPage', 
                command: 'getFilters'
            }
            $.ajax({
                url: controller,
                data: query,
                type: 'post',
                success: function(data) {
                    let post_data = JSON.parse(data);
                    // add the data to the form so it is remembered
                    $('#search').val(post_data['search']);
                    $('#group-by').val(post_data['order']);
                    $('#experience').val(post_data['experience']);
                }
            });
        }

        // for if user would like to change the filters
        $('#filter-form').submit(function(event) {
            event.preventDefault(); // Prevent the default form submission
            
            let formData = new FormData(this);
            
            // Send the form data to the server using AJAX POST request
            $.ajax({
                url: controller,
                type: 'POST',
                data: formData, // Send the FormData object directly
                processData: false, // Prevent jQuery from processing the data
                contentType: false, // Prevent jQuery from setting the Content-Type header
                success: function(data) {
                    // Handle the response data here
                    addPosts();
                },
                error: function(xhr, status, error) {
                    // Handle errors here
                    console.error(xhr.responseText);
                }
            });
        });

        // create post
        $('#createPostForm').submit(function(event) {
            event.preventDefault();

            let formData = new FormData(this);

            $.ajax({
                url: controller,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function() {
                    $('#createPost').modal('hide');
                    addPosts();
                    alert('Post Created');
                }
            });
        });

        //handle logout click
        $('#logOutNav').click(logOut);
        // handle profile click
        $('#profileNav').click(profile);
        // handle my posts click
        $('#myPostsNav').click(myPosts);
        // have filters set when page refreshes
        savedFilters();
        // add posts when page is refreshed
        addPosts();
    </script>
</html>